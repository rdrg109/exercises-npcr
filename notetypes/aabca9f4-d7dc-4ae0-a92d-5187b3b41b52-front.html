<my-anki-field name="audio-identifier">{{audio identifier}}</my-anki-field>
<my-anki-field name="content">{{content}}</my-anki-field>

<style>
  .card {
    font-family: ;
    font-size: 20px;
    text-align: center;
    color: black;
    background-color: white;
  }

  #text {
    text-align: left;
  }

  .line {
    line-height: 30px;
  }

  .sentence {
    text-decoration: underline;
    text-underline-offset: 6px;
    margin: 4px;
  }

  .sentence:hover {
    background-color: yellow;
  }

  .missing-part {
    background-color: red;
    padding: 0px 20px;
  }

  .missing-character {
    background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cpolygon points='0 0,100 0, 100 100, 0 100, 0 0' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 3;'/%3E%3Cpolygon points='50 0,100 50, 50 100, 0 50, 50 0' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 3;'/%3E%3Cpolygon points='25 25, 75 25, 75 75, 25, 75, 25 25' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 3;'/%3E%3Cpolygon points='0 0,100 100' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 2 5;'/%3E%3Cpolygon points='0 100,100 0' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 2 5;'/%3E%3Cpolygon points='0 50,100 50' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 3;'/%3E%3Cpolygon points='50 0,50 100' style='stroke: black; fill-opacity: 0%25; stroke-width: 0.5; stroke-dasharray: 3;'/%3E%3C/svg%3E%0A");
    background-size: contain;
    background-repeat: no-repeat;
    font-size: 90pt;
    padding: 15px;
    background-position: center 13pt;
    font-family: STKaiti;
  }
</style>

<script src="exercises.js"></script>
<script src="anki-persistence-v1.1.8-minified.js"></script>
<script>
  function encloseEachLineInDiv(node) {
    const children = node.childNodes
    for(var i=0; i<children.length; ++i) {
      let child = children[i]
      if(child.nodeType == 3) {
        const node = document.createElement('div')
        node.classList.add('line')
        // We execute .trim() because the first line of an Anki field sometimes
        // have spaces.
        node.textContent = child.data.trim()
        child.parentNode.replaceChild(node, child)
      }
    }
    //Remove <br> that are automatically added by Anki
    const brNodes = node.getElementsByTagName('br')
    while(brNodes[0])
      brNodes[0].parentNode.removeChild(brNodes[0])
  }

  function replaceAudiosWithCustomTag(node) {
    node.innerHTML = node.innerHTML.replace(
      /\[\[file:([^\]]+)\]\[\(audio\)\]\]/g,
      (all, c1) => {
        return '<my-audio filename="' + c1 + '"></my-audio>'
      }
    )
  }


  function createSpanForEachSegment(node) {
    const divs = node.querySelectorAll('div')
    for(div of divs) {
      const children = div.childNodes
      for(var i=0; i<children.length; ++i) {
        let child = children[i]
        if(child.nodeType == 3) {
          // Check if the current children is the name of the character
          // that is the speaker of the corresponding line. If that''s the case,
          // skip that part because we are not interested in adding placeholders
          // to the name of characters.
          if(i == 0 && /^.{2,3}ï¼š/.test(child.nodeValue)) {
            const match = child.nodeValue.match(/^([^ï¼š]{2,3})(ï¼š)(.+)/)
            const node1 = document.createElement('span')
            const node2 = document.createElement('span')
            const node3 = document.createElement('span')
            node1.textContent = match[1]
            node2.textContent = 'ï¼š'
            node3.textContent = match[3]
            node3.classList.add('sentence')
            // Insert part of dialogue
            child.parentNode.replaceChild(node3, child)
            // Insert ellipsis
            node3.parentNode.insertBefore(node2, node3)
            // Insert name of the character that reads that part
            node2.parentNode.insertBefore(node1, node2)
          }
          else {
            const node = document.createElement('span')
            node.textContent = child.data
            node.classList.add('sentence')
            child.parentNode.replaceChild(node, child)
          }
        }
      }
    }
  }

  function addListenerToAudiosPreviousSiblingPlayAudio() {
    const nodeAudios = document.querySelectorAll('my-audio')
    // If we don't explicitly write "let", then the last audio will always be played.
    for(let nodeAudio of nodeAudios) {
      const nodeBeforeAudio = nodeAudio.previousSibling
      nodeBeforeAudio.addEventListener('click', function(e) {
        const filename = nodeAudio.getAttribute('filename')
        var audio = new Audio(filename)
        audio.play()
      })
    }
  }

  function hideTextToPractice() {
    // Find node by text. Retrieved from https://stackoverflow.com/questions/58052522
    //
    // The context is a given node, so the xpathExpression should
    // start with ".//" so that only nodes within the context are
    // searched. More discussion in https://stackoverflow.com/questions/32783842
    const node = document.evaluate(
      `.//*[contains(text(), "ðŸŸ¦")]`,
      document.getElementById('text'),
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue
    node.classList.remove('sentence')
    node.classList.add('missing-part')
    Persistence.setItem('missing-characters', node.textContent.replace(/(ï¼Œ|ã€‚|ðŸŸ¦)/g, ''))
    Persistence.setItem('missing-characters-audio', node.nextSibling.getAttribute('filename'))
    node.textContent = ' '
  }

  clearAllIntervals()

  var data = getAllAnkiFields()
  var parent = document.getElementById('qa')

  var text = document.createElement('div')
  text.innerHTML = data['content']
  text.id = 'text'
  encloseEachLineInDiv(text)
  replaceAudiosWithCustomTag(text)
  createSpanForEachSegment(text)

  parent.appendChild(text)

  addListenerToAudiosPreviousSiblingPlayAudio()
  hideTextToPractice()
  // Play audio when opening the card
  var audio = new Audio(Persistence.getItem('missing-characters-audio'))
  audio.play()
  // Play audio every few seconds
  setInterval(function() {
    var audio = new Audio(Persistence.getItem('missing-characters-audio'))
    audio.play()
  }, 5000)
  </script>
